---
- name: Modify sudo configuration
  template:
    src: 'sudoers.d.j2'
    dest: "/etc/sudoers.d/{{ item.user }}"
    mode: '0440'
    owner: 'root'
    group: 'root'
    validate: "/usr/sbin/visudo -cf %s"
  with_items:
    - '{{ sudoers }}'
  tags:
    - configuration
    - sudo

- name: Remove sudoers configuration
  file:
    path: '/etc/sudoers.d/{{ item.user }}'
    state: 'absent'
  with_items:
    - '{{ sudoers }}'
  when: sudoers.0.remove is defined and sudoers.0.remove
  tags:
    - configuration
    - sudo
